---
title: "Untitled"
author: "Pierre Gardan"
date: "12/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading packages, warning=FALSE, message=FALSE}
library(knitr)
# install.packages("kableExtra")
library(kableExtra)
library(tidyverse)

# install.packages(c("dga", "MCMCpack", "Rcapture", "LCMCR", "MASS", "coda"))
library(dga)
library(MCMCpack)
library(Rcapture)
library(LCMCR)
library(parallel)
source("../input/silverman_code/datasets.R")
source("../input/silverman_code/functions.R")
source("../src/prettyplot.R")
```


```{r UK data, eval=FALSE}
UKdat_4
```
```{r}
model <- MSEfit(UKdat_4)
```

```{r}

simulate_data <- function(fitted, nsim, n_lists) {
  Y = simulate(fitted, nsim=nsim)
  mat = model.matrix(fitted)
  
  # Binary table with all combinations of zeros and ones
  X = eval(parse(text=
                   paste0("table(", paste0(rep("c(0,1)", n_lists), collapse=","), ")")
  )) %>% 
    as.data.frame.table %>% 
    map_dfc(as.numeric) - 1
  X = X[nrow(X):2, n_lists:1]
  colnames(X) = paste0("list", 1:n_lists)

  cbind(Y, X)
}

true_abondance = model$CI[1]
nsim = 120
n_lists = 4

dat = simulate_data(model$fit, nsim=nsim, n_lists=n_lists)
simulation_names = paste0("sim_", 1:nsim)
list_names = paste0("list", 1:n_lists)


estimates = unlist(mclapply(simulation_names, function(sim) {
  MSEfit(dat[, c(paste0("list", 1:4), sim)])$CI[1]
}, 
mc.cores = 12))
```

```{r}
hist(estimates, xlab="Estimated abundance")
abline(v=true_abondance)
abline(v=model$CI[2], lty=2)
abline(v=model$CI[3], lty=2)
```




